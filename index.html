<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qwen Turbo Voice</title>
    <style>
        /* STYLE QWEN DARK */
        :root {
            --bg-color: #000;
            --primary: #10a37f;
            --accent: #00f0ff;
            --speaking: #10a37f;
            --text-main: #ffffff;
            --text-sub: #666;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text-main);
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* START OVERLAY */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .btn-start {
            padding: 20px 50px; font-size: 1.5rem; background: var(--primary); color: white;
            border: none; border-radius: 50px; cursor: pointer; text-transform: uppercase;
            letter-spacing: 2px; font-weight: bold;
            box-shadow: 0 0 30px rgba(16, 163, 127, 0.5);
            animation: pulse-green 2s infinite;
        }

        /* STAGE UTAMA */
        #stage { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; }
        
        /* CORE VISUALIZER */
        .core {
            width: 180px; height: 180px; border-radius: 50%;
            background: #1a1a1a; border: 2px solid #333;
            display: flex; align-items: center; justify-content: center;
            position: relative; transition: all 0.2s;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .core svg { width: 60px; height: 60px; fill: #555; transition: fill 0.2s; }

        /* STATES */
        .core.listening { border-color: var(--accent); box-shadow: 0 0 40px rgba(0, 240, 255, 0.2); }
        .core.listening svg { fill: var(--accent); animation: breathe 2s infinite; }

        .core.thinking { border-color: #ffd700; transform: scale(1.1); }
        .core.thinking svg { fill: #ffd700; animation: spin 0.5s linear infinite; }

        .core.speaking { border-color: var(--primary); box-shadow: 0 0 50px rgba(16, 163, 127, 0.6); transform: scale(1.05); }
        .core.speaking svg { fill: var(--primary); }

        /* TEXT LOG */
        #log-display {
            position: absolute; bottom: 100px; width: 100%; text-align: center;
            font-size: 1.2rem; color: #888; font-weight: 500; min-height: 30px;
        }

        /* SETTINGS */
        #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #222; padding: 25px; border-radius: 10px; width: 300px; border: 1px solid #444; text-align: center; }
        .api-input { width: 100%; padding: 10px; background: #111; border: 1px solid #444; color: white; border-radius: 5px; margin: 10px 0; box-sizing: border-box; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; }

        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16,163,127,0); } 70% { box-shadow: 0 0 30px rgba(16,163,127,0); } 100% { box-shadow: 0 0 0 0 rgba(16,163,127,0); } }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="start-overlay">
        <button class="btn-start" onclick="startApp()">MULAI CEPAT</button>
        <div style="color:#666; margin-top:15px;">Mode Suara Turbo - Tanpa Delay</div>
    </div>

    <div id="stage">
        <div class="core" id="visual-core">
            <svg viewBox="0 0 24 24">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        </div>
    </div>

    <div id="log-display">Menunggu...</div>

    <div id="modal">
        <div class="modal-box">
            <h3>Pengaturan</h3>
            <input type="password" id="api-key" class="api-input" placeholder="Groq API Key (gsk_...)">
            <button class="btn-save" onclick="saveSettings()">SIMPAN</button>
            <div onclick="document.getElementById('modal').style.display='none'" style="margin-top:10px; cursor:pointer; color:#666;">Tutup</div>
        </div>
    </div>

    <script>
        /* --- ENGINE: TURBO SPEED --- */
        
        // 1. CONFIG
        const API_URL = 'https://api.groq.com/openai/v1/chat/completions';
        const MODEL = 'llama-3.3-70b-versatile'; // Model yang sangat cepat
        const SPEECH_RATE = 1.2; // 1.2x Lebih Cepat dari normal (1.0)
        
        let API_KEY = localStorage.getItem('qwen_turbo_key') || '';
        let chatHistory = [];
        let isActive = false;

        // DOM
        const core = document.getElementById('visual-core');
        const log = document.getElementById('log-display');
        const modal = document.getElementById('modal');
        const keyInput = document.getElementById('api-key');

        if (!API_KEY) modal.style.display = 'flex';
        else keyInput.value = API_KEY;

        // 2. VOICE ENGINE (SPEED TUNED)
        const synth = window.speechSynthesis;
        let bestVoice = null;

        function loadVoice() {
            const v = synth.getVoices();
            const idV = v.filter(x => x.lang === 'id-ID');
            if (idV.length > 0) bestVoice = idV[0];
        }
        if (speechSynthesis.onvoiceschanged) speechSynthesis.onvoiceschanged = loadVoice;
        loadVoice();

        function speak(text) {
            if (synth.speaking) synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            if (bestVoice) u.voice = bestVoice;
            
            // PENGATURAN KECEPATAN (TURBO)
            u.pitch = 1.1; // Sedikit tinggi biar jelas walaupun cepat
            u.rate = SPEECH_RATE; // CEPAT (1.2x)
            
            synth.speak(u);
        }

        // 3. LISTENING ENGINE
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'id-ID';
        recognition.interimResults = false;

        recognition.onstart = () => { setVisual('listening'); };
        recognition.onend = () => { /* Jangan lakukan apa-apa di sini, biarkan 'process' yang handle flow */ };
        
        recognition.onresult = (e) => {
            const text = e.results[0][0].transcript;
            if (!text) return;
            
            log.innerText = "Kamu: " + text;
            processAI(text);
        };

        // 4. LOGIC & FLOW (TANPA DELAY)
        async function processAI(text) {
            if (!API_KEY) {
                log.innerText = "Error: Masukkan API Key dulu.";
                modal.style.display = 'flex';
                setVisual('idle');
                return;
            }

            setVisual('thinking');
            chatHistory.push({ role: "user", content: text });
            chatHistory.push({ role: "assistant", content: "..." }); // Placeholder biar gantian

            const payload = [
                { role: "system", content: "Kamu AI yang super cepat, ringkas, dan to the point." },
                ...chatHistory.slice(-10)
            ];

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: payload, model: MODEL, temperature: 0.5 })
                });
                const data = await res.json();
                
                if (data.choices && data.choices.length > 0) {
                    const reply = data.choices[0].message.content;
                    
                    // Update History
                    chatHistory[chatHistory.length-1] = { role: "assistant", content: reply };
                    
                    log.innerText = reply;
                    speak(reply);
                    setVisual('speaking');
                } else {
                    throw new Error("No response");
                }
            } catch (err) {
                log.innerText = "Error: " + err.message;
                setVisual('idle');
                startListening(); // Retry if error
            }
        }

        // VISUAL STATE MANAGER
        function setVisual(state) {
            core.className = 'core'; // Reset
            if (state === 'listening') {
                core.classList.add('listening');
            } else if (state === 'thinking') {
                core.classList.add('thinking');
            } else if (state === 'speaking') {
                core.classList.add('speaking');
            } else {
                // Idle
            }
        }

        function startApp() {
            document.getElementById('start-overlay').style.display = 'none';
            isActive = true;
            startListening();
        }

        function startListening() {
            if (!isActive) return;
            try { recognition.start(); } catch(e) {}
        }

        function speak(text) {
            // Saat AI bicara, matikan mic biar gak noise
            try { recognition.stop(); } catch(e) {}
            speak(text);
        }

        // EVENT HANDLERS
        // Override fungsi speak bawaan dengan logika flow otomatis
        const originalSpeak = window.speechSynthesis.prototype.speak;
        window.speechSynthesis.prototype.speak = function(utterance) {
            originalSpeak.call(this, utterance);
            
            // KUNCI KECEPATAN: Selesai bicara -> Langsung dengar (Delay 0ms)
            utterance.onend = function() {
                log.innerText = ""; // Clear text biar fokus ke dengar
                setTimeout(startListening, 0); // TANPA DELAY!
            };
        };

        function saveSettings() {
            const k = keyInput.value.trim();
            if(k) {
                API_KEY = k;
                localStorage.setItem('qwen_turbo_key', k);
                modal.style.display = 'none';
                if(!isActive) startApp();
            }
        }

        // Klik Core untuk manual toggle (Opsional)
        core.addEventListener('click', () => {
            if (isActive && core.classList.contains('listening')) {
                core.classList.remove('listening');
                recognition.stop();
            } else {
                startListening();
            }
        });

    </script>
</body>
</html>
