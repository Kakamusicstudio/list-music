<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qwen AI - Voice Chat</title>
    <style>
        :root {
            --bg-dark: #171717;
            --primary: #10a37f; /* Qwen Green */
            --listening-color: #00f0ff; /* Biru saat dengar */
            --speaking-color: #10a37f; /* Hijau saat bicara */
            --text-main: #ececec;
            --text-sub: #666;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-dark);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: var(--text-main);
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* Header Kecil */
        header {
            position: absolute; top: 0; left: 0; width: 100%;
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 10; border-bottom: 1px solid #333;
        }
        .brand { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 8px; }

        /* Layar Utama */
        .main-stage {
            flex: 1; position: relative; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }

        /* STATUS BESAR (Penting untuk Mode Suara) */
        .status-display {
            text-align: center;
            margin-bottom: 40px;
            z-index: 5;
            transition: all 0.3s;
        }

        .status-title {
            font-size: 1.2rem; font-weight: 600; margin-bottom: 5px;
            text-transform: uppercase; letter-spacing: 2px;
        }

        .status-sub {
            font-size: 0.9rem; color: var(--text-sub);
        }

        /* Visualisasi Gelombang Suara (Hanya CSS) */
        .wave-container {
            display: flex; align-items: center; justify-content: center; gap: 6px; height: 40px;
            opacity: 0; transition: opacity 0.3s;
        }
        .bar { width: 6px; background: var(--primary); border-radius: 4px; animation: none; }

        /* Tombol Mikrofon Besar */
        .mic-button-large {
            width: 80px; height: 80px; border-radius: 50%;
            background: #2d2d2d; border: 2px solid #444;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            position: relative; z-index: 20;
        }
        .mic-button-large svg { width: 30px; height: 30px; fill: #888; transition: fill 0.3s; }

        /* States */
        /* 1. Listening */
        .mic-button-large.listening {
            border-color: var(--listening-color);
            background: #1a1a1a;
            animation: pulse-blue 2s infinite;
        }
        .mic-button-large.listening svg { fill: var(--listening-color); }
        
        /* 2. Speaking */
        .mic-button-large.speaking {
            border-color: var(--speaking-color);
            background: var(--speaking-color);
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(16, 163, 127, 0.4);
        }
        .mic-button-large.speaking svg { fill: white; }

        /* Chat Transkrip (Background) */
        #chat-log {
            position: absolute; top: 80px; bottom: 100px; left: 0; right: 0;
            overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            opacity: 0.3; pointer-events: none; /* Supaya tidak ganggu */
            align-items: center;
        }
        .log-item { font-size: 0.9rem; color: #888; max-width: 80%; text-align: center; }
        .log-item.ai { color: var(--primary); font-weight: 500; }

        /* Animations */
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(0, 240, 255, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(0, 240, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 240, 255, 0); }
        }
        
        @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 30px; } }
        
        .speaking .wave-container { opacity: 1; }
        .speaking .bar { animation: wave 0.5s infinite ease-in-out; }
        .bar:nth-child(2) { animation-delay: 0.1s; }
        .bar:nth-child(3) { animation-delay: 0.2s; }
        .bar:nth-child(4) { animation-delay: 0.3s; }
        .bar:nth-child(5) { animation-delay: 0.4s; }

        /* Settings Overlay */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #2d2d2d; padding: 30px; border-radius: 12px;
            width: 300px; text-align: center; border: 1px solid #444;
        }
        select { width: 100%; padding: 10px; background: #171717; color: white; border: 1px solid #444; margin-top: 10px; border-radius: 6px; }
        button.close-btn { margin-top: 20px; background: var(--primary); color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <span style="color:white;">●</span> Qwen Voice
        </div>
        <div onclick="document.getElementById('settings-modal').style.display='flex'" style="color:#666; cursor:pointer;">⚙️</div>
    </header>

    <div class="main-stage">
        
        <!-- Log Chat (Background) -->
        <div id="chat-log">
            <div class="log-item">Siap untuk berkomunikasi suara...</div>
        </div>

        <!-- Teks Status -->
        <div class="status-display" id="status-display">
            <div class="status-title" id="status-title">OFFLINE</div>
            <div class="status-sub" id="status-sub">Klik tombol untuk mulai</div>
        </div>

        <!-- Visualizer (Hanya saat bicara) -->
        <div class="wave-container" id="wave-container">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>

        <!-- Tombol Utama -->
        <div class="mic-button-large" id="main-btn">
            <svg viewBox="0 0 24 24">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        </div>

    </div>

    <!-- Modal Settings Suara -->
    <div id="settings-modal">
        <div class="modal-box">
            <h3 style="margin-top:0">Pengaturan Suara</h3>
            <select id="voice-selector"></select>
            <button class="close-btn" onclick="document.getElementById('settings-modal').style.display='none'">Tutup</button>
        </div>
    </div>

    <script>
        /* 
         * ENGINE: KONVERASI SUARA PENUH
         * Flow: Idle -> Listen -> Process -> Speak -> (Auto) Listen
         */

        // --- 1. VOICE ENGINE (TTS) ---
        const synth = window.speechSynthesis;
        let voices = [];
        let bestVoice = null;

        function initVoices() {
            voices = synth.getVoices();
            const idVoices = voices.filter(v => v.lang.startsWith('id-ID'));
            
            // Urutkan: Google > Microsoft > Lainnya
            idVoices.sort((a, b) => {
                const na = a.name.toLowerCase();
                const nb = b.name.toLowerCase();
                if (na.includes('google')) return -1;
                if (nb.includes('google')) return 1;
                if (na.includes('microsoft')) return -1;
                if (nb.includes('microsoft')) return 1;
                return 0;
            });

            // Isi Dropdown
            const select = document.getElementById('voice-selector');
            select.innerHTML = '';
            idVoices.forEach((v, i) => {
                const opt = document.createElement('option');
                opt.value = i; // Index di array voices asli
                opt.text = v.name;
                select.appendChild(opt);
            });

            if(idVoices.length > 0) {
                bestVoice = idVoices[0];
                console.log("Voice Terpilih:", bestVoice.name);
            }
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }
        initVoices();
        setTimeout(initVoices, 1000); // Force load

        // Fungsi Bicara
        function speak(text) {
            if (synth.speaking) synth.cancel();
            // Matikan mic saat AI bicara (Hindari feedback)
            if (recognition) recognition.stop();

            const utter = new SpeechSynthesisUtterance(text);
            
            // Ambil suara dari dropdown atau suara terbaik
            const select = document.getElementById('voice-selector');
            if (voices.length > 0) {
                const idx = select.selectedIndex;
                // Filter ulang karena array 'voices' is global, select.value index-nya relatif thd filtered list
                // Simplifikasi: Pakai bestVoice jika user tidak ganti setting, atau cari ulang
                // Agar simpel, kita pakai bestVoice saja jika belum diset manual
                utter.voice = bestVoice;
            }

            utter.pitch = 1.1; // Cewe
            utter.rate = 0.95; // Natural
            utter.volume = 1.0;

            // State UI: Speaking
            setUIState('speaking');

            utter.onend = () => {
                // SELESAI BICARA -> KEMBALI MENDENGARKAN
                console.log("Selesai bicara, kembali listen...");
                setUIState('idle');
                setTimeout(startListening, 500); // Delay sedikit biar natural
            };

            synth.speak(utter);
        }

        // --- 2. LISTENING ENGINE (STT) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Kalimat per kalimat dulu, lebih stabil
            recognition.lang = 'id-ID';
            recognition.interimResults = false;

            recognition.onstart = () => {
                setUIState('listening');
            };

            recognition.onend = () => {
                // Jangan auto restart di sini.
                // Biarkan 'speak()' yang mengatur restart via 'onend'.
                // Kecuali jika user matikan manual.
            };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                addLog(text, 'user');
                processAI(text);
            };

            recognition.onerror = (e) => {
                console.error(e);
                setUIState('idle');
            };
        }

        // --- 3. LOGIKA KONTROL ---
        let isActive = false;

        function startListening() {
            if (!recognition || isActive === 'speaking') return;
            try {
                recognition.start();
                isActive = true;
                setUIState('listening');
            } catch(e) { console.log("Sudah listening"); }
        }

        function stopListening() {
            if (!recognition) return;
            try {
                recognition.stop();
                isActive = false;
            } catch(e) {}
        }

        // Tombol Utama
        const mainBtn = document.getElementById('main-btn');
        
        mainBtn.addEventListener('click', () => {
            if (isActive) {
                // MATIKAN
                stopListening();
                if (synth.speaking) synth.cancel();
                setUIState('offline');
                isActive = false;
            } else {
                // NYALAKAN
                startListening();
            }
        });

        // Update UI State
        function setUIState(state) {
            const btn = document.getElementById('main-btn');
            const title = document.getElementById('status-title');
            const sub = document.getElementById('status-sub');
            const wave = document.getElementById('wave-container');

            // Reset
            btn.className = 'mic-button-large';
            wave.style.opacity = '0';

            if (state === 'listening') {
                btn.classList.add('listening');
                title.innerText = "MENDENGARKAN...";
                title.style.color = "var(--listening-color)";
                sub.innerText = "Silakan bicara...";
                isActive = true;
            } 
            else if (state === 'speaking') {
                btn.classList.add('speaking');
                title.innerText = "BERBICARA";
                title.style.color = "var(--speaking-color)";
                sub.innerText = "Qwen sedang menjawab...";
                wave.style.opacity = '1';
                isActive = 'speaking';
            } 
            else if (state === 'offline') {
                title.innerText = "OFFLINE";
                title.style.color = "#888";
                sub.innerText = "Klik tombol untuk mulai";
            }
            else { // Idle
                title.innerText = "SIAP";
                title.style.color = "#888";
                sub.innerText = "Menunggu suara...";
            }
        }

        function addLog(text, sender) {
            const log = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = `log-item ${sender}`;
            div.innerText = (sender === 'user' ? "Kamu: " : "Qwen: ") + text;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        // OTAK AI
        function processAI(text) {
            const t = text.toLowerCase();
            let reply = "";

            if (t.match(/halo|hai|pagi|siang|sore|malam/)) reply = "Halo. Apa yang bisa saya bantu dengan suara hari ini?";
            else if (t.match(/siapa|nama|kamu/)) reply = "Saya adalah Qwen. Asisten virtual yang suka mengobrol.";
            else if (t.match(/jam|waktu/)) {
                const d = new Date();
                reply = `Sekarang pukul ${d.getHours()} lewat ${d.getMinutes()}.`;
            }
            else if (t.match(/terima kasih|makasih/)) reply = "Sama-sama.";
            else if (t.match(/bisa apa/)) reply = "Saya bisa mengobrol, bercanda, dan menjawab pertanyaan sederhana.";
            else if (t.match(/lagi|capek|sedih/)) reply = "Jangan sedih ya. Ceritakan sama saya, saya siap mendengar.";
            else reply = "Maaf, suaranya kurang jelas atau saya belum paham maksudmu. Bisa ulangi?";

            speak(reply);
        }

    </script>
</body>
</html>
